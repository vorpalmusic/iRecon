#!/bin/bash

# Author: Gzzcoo - expanded by JackDaw

yellow="\e[33m"
blue="\e[34m"
gray="\e[90m"
end="\e[0m"
purple="\e[0;35m\033[1m"

if [ -z "$1" ]; then
    echo -e "\n${yellow}[!]${end} ${purple}Usage:${end} ${blue}$0 <IP>${end}"
    exit 1
fi

target="$1"

# Resolve helper dir (modules) relative to this script, works via symlink
MODDIR="$(cd -- "$(dirname -- "$(readlink -f -- "${BASH_SOURCE[0]}")")"/modules >/dev/null 2>&1 && pwd)"

# Keep OUTDIR under the caller's current dir (your original behavior)
BASEDIR="$(pwd)"
OUTDIR="${BASEDIR}/$target"

# Project root = parent of modules; lists live there
ROOTDIR="$(cd -- "$MODDIR/.." && pwd -P)"
LISTDIR="${ROOTDIR}/lists"

mkdir -p "$OUTDIR"
echo -e "${yellow}[*]${end} ${purple}Using output directory:${end} ${blue}$OUTDIR${end}"

"$MODDIR/banner"

### run very fast nmap scan just to find open ports
echo -e "\n${yellow}[*]${end} ${purple}Scanning ports on${end} ${blue}$target${end}${purple}...${end}\n"
sudo /usr/bin/nmap -p- --open -sS --min-rate 1000 -n -Pn -vvv "$target" -oG "$OUTDIR/allPorts" 2>/dev/null | grep "Discovered open port"

### grab all those ports from the nmap scan and put them in a list
IP="$target"
ports=$(grep -oP '\d{1,5}/open' "$OUTDIR/allPorts" | cut -d '/' -f1 | xargs | tr ' ' ',')

echo -e "\n${yellow}[*]${end} ${purple}Extracting information...${end}\n" > extractPorts.tmp
echo -e "\t${yellow}[*]${end} ${purple}IP Address:${end} ${blue}$IP${end}" >> extractPorts.tmp
echo -e "\t${yellow}[*]${end} ${purple}Open ports:${end} ${blue}$ports${end}\n" >> extractPorts.tmp
echo "$ports" | tr -d '\n' | xclip -sel clip
echo -e "${yellow}[*]${end} ${purple}Ports copied to clipboard${end}" >> extractPorts.tmp
/usr/bin/batcat --style=plain --paging=never extractPorts.tmp
rm extractPorts.tmp

# --- targeted scan (only if we have ports) ---
if [ -n "$ports" ]; then
  echo -e "\n${yellow}[*]${end} ${purple}Version and Service Scanning...${end}"
  sudo /usr/bin/nmap -sCV -p"$ports" -n -Pn --max-retries 2 --host-timeout 30s "$IP" -A \
       -oN "$OUTDIR/targeted" -oX "$OUTDIR/targetedXML" >/dev/null 2>&1
else
  echo -e "${yellow}[!]${end} ${purple}No open ports detected; skipping targeted scan.${end}"
fi

### http-detect
eval "$("$MODDIR/http-detect" "$OUTDIR" "$IP")"
echo -e "${yellow}[*]${end} ${purple}HTTP candidates:${end} ${blue}${HTTP_CAND:-<none>}${end}"
echo -e "${yellow}[*]${end} ${purple}Verified HTTP ports:${end} ${blue}${HTTP_VERIFIED:-<none>}${end}"

# --- http-collect for verified HTTP ports (minimal & robust) ---
if [ -n "${HTTP_VERIFIED:-}" ]; then
  for p in $(echo "${HTTP_VERIFIED}" | tr ',' ' '); do
    p="${p//[^0-9]/}"
    [ -z "$p" ] && continue
    "$MODDIR/http-collect" "$OUTDIR" "$IP" "$p" >/dev/null 2>&1 || true
  done
fi
# --- end collection ---

# --- show emails we scraped from the HTTP bodies (if any) ---
emails_tmp="$OUTDIR/.emails.tmp"
: > "$emails_tmp"
if [ -n "${HTTP_VERIFIED:-}" ]; then
  for p in $(echo "${HTTP_VERIFIED}" | tr ',' ' '); do
    f="$OUTDIR/http/$p/emails.txt"
    [ -s "$f" ] && cat "$f" >> "$emails_tmp"
  done
fi
if [ -s "$emails_tmp" ]; then
  emails_sorted="$(sort -u "$emails_tmp")"
  echo -e "${yellow}[*]${end} ${purple}Emails found in page content:${end}"
  while IFS= read -r e; do
    echo -e "   ${blue}${e}${end}"
  done <<< "$emails_sorted"
fi
rm -f "$emails_tmp"
# --- end emails summary ---

# assume HTTP_CAND contains e.g. s3.thetoppers.htb and HTTP_VERIFIED contains ports
target_hint="${HTTP_CAND:-$IP}"
found_hosts="$("$MODDIR/passive-enrich" "$OUTDIR" "$target_hint" --max 200)"
echo -e "${yellow}[*]${end} ${purple}Passive hosts found:${end}"
echo "$found_hosts" | sed '/^$/d' | while IFS= read -r h; do
  echo -e "   ${blue}$h${end}"
done

# --- Add /etc/hosts entries ONCE (denylist-aware) ---
added="$(sudo bash "$MODDIR/add-hosts" "$OUTDIR" "$IP" "${HTTP_VERIFIED:-}" --deny-file "$LISTDIR/deny-domains")"
if [ -n "$added" ]; then
  echo -e "${yellow}[*]${end} ${purple}Hosts added to /etc/hosts:${end}"
  echo "$added"
else
  echo -e "${yellow}[*]${end} ${purple}No new /etc/hosts entries needed.${end}"
fi

### generate HTML report
echo -e "\n${yellow}[*]${end} ${purple}Generating HTML Report and opening with the browser...${end}"
NMAP_XSL="/usr/share/nmap/nmap.xsl"
if [ ! -f "$NMAP_XSL" ]; then
  NMAP_XSL="$(find /usr -name nmap.xsl 2>/dev/null | head -n1 || true)"
fi

if [ -s "$OUTDIR/targetedXML" ]; then
  if [ -n "$NMAP_XSL" ] && [ -f "$NMAP_XSL" ]; then
    xsltproc -o "$OUTDIR/index.html" "$NMAP_XSL" "$OUTDIR/targetedXML" || echo "[!] xsltproc failed"
  else
    echo "[!] nmap.xsl stylesheet not found; cannot generate HTML"
  fi
else
  echo "[!] targetedXML missing or empty; skipping HTML generation"
fi

# Launch a tiny HTTP server to view the report, then close
(
  python3 -m http.server 6969 -d "$OUTDIR" &
  server_pid=$!
  sleep 1
  /usr/bin/firefox "http://127.0.0.1:6969/index.html" &
  sleep 6
  kill "$server_pid" &>/dev/null
) &>/dev/null
