#!/usr/bin/env bash
# reporter: append Lantern module summary to the generated HTML report
# Usage (from lantern): "$rep" "$OUTDIR"
set -euo pipefail

OUTDIR="${1:?OUTDIR required as \$1}"

INDEX_HTML="$OUTDIR/report/index.html"
TARGETED_XML="$OUTDIR/report/targetedXML"

[[ -s "$INDEX_HTML" ]] || { echo "[reporter] missing report: $INDEX_HTML" >&2; exit 0; }

# HTTP artifacts live under $OUTDIR/http/<port>/
HTTP_ROOT="$OUTDIR/http"
http_items=()
if [[ -d "$HTTP_ROOT" ]]; then
  while IFS= read -r d; do
    p="$(basename "$d")"
    [[ "$p" =~ ^[0-9]+$ ]] || continue
    http_items+=("$p")
  done < <(find "$HTTP_ROOT" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | sort -V)
fi

ts="$(date -u +'%Y-%m-%d %H:%M:%SZ')"

{
  echo ''
  echo '<hr/>'
  echo '<section id="lantern-summary" style="font-family: system-ui, sans-serif;">'
  echo '  <h2 style="margin:0.5em 0;">Lantern Modules Summary</h2>'
  echo "  <div style=\"font-size:0.9em;color:#555;\">Generated: ${ts} (UTC)</div>"

  if (( ${#http_items[@]} )); then
    echo '  <h3 style="margin:0.5em 0 0.25em;">HTTP</h3>'
    echo '  <ul style="margin:0.25em 0 0.75em 1.25em;">'
    for p in "${http_items[@]}"; do
      # link from /report/index.html up to ../http/<port>/
      echo "    <li>Port ${p} â€” <a href=\"../http/${p}/\" target=\"_blank\" rel=\"noopener\">open folder</a></li>"
    done
    echo '  </ul>'
  else
    echo '  <h3 style="margin:0.5em 0 0.25em;">HTTP</h3>'
    echo '  <p style="margin:0.25em 0 0.75em;">No HTTP artifacts found.</p>'
  fi

  if [[ -s "$TARGETED_XML" ]]; then
    echo '  <h3 style="margin:0.5em 0 0.25em;">Raw Artifacts</h3>'
    echo '  <ul style="margin:0.25em 0 0.75em 1.25em;">'
    echo '    <li><code>targetedXML</code> present</li>'
    echo '  </ul>'
  fi

  echo '</section>'
} >> "$INDEX_HTML"

echo "[reporter] appended Lantern summary to $(realpath -m "$INDEX_HTML")"
