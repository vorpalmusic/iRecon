#!/usr/bin/env bash
# http-detect  (quiet-by-default; -v prints diagnostics to stderr)
set -u

VERBOSE=0
if [[ "${1:-}" == "-v" || "${1:-}" == "--verbose" ]]; then
  VERBOSE=1
  shift
fi

OUTDIR="${1:-}"
IP="${2:-}"
PORTS_ARG="${3:-}"   # optional: probe-mode

if [ -z "$OUTDIR" ] || [ -z "$IP" ]; then
  echo "Usage: $0 [-v] OUTDIR IP [PORTS]" >&2
  exit 2
fi

xml_file="$OUTDIR/report/targetedXML"

HTTP_CAND=""
HTTP_VERIFIED=""

probe_ports() {
  local ip="$1" portlist="$2"
  local -a arr verified=()
  portlist="${portlist//,/ }"
  read -r -a arr <<< "$portlist"
  for p in "${arr[@]}"; do
    p="${p//[^0-9]/}"
    [ -z "$p" ] && continue
    if curl -Is --max-time 3 "http://$ip:$p/" >/dev/null 2>&1 \
    || curl -kIs --max-time 3 "https://$ip:$p/" >/dev/null 2>&1; then
      verified+=("$p")
    fi
  done
  if [ "${#verified[@]}" -gt 0 ]; then
    printf "%s" "$(printf "%s," "${verified[@]}" | sed 's/,$//')"
  fi
}

# Probe-mode: uses provided PORTS; prints only assignments
if [ -n "$PORTS_ARG" ]; then
  HTTP_VERIFIED="$(probe_ports "$IP" "$PORTS_ARG")"
  printf "HTTP_CAND='%s'\nHTTP_VERIFIED='%s'\n" \
    "${HTTP_CAND//\'/\'\"\'\"\'}" "${HTTP_VERIFIED//\'/\'\"\'\"\'}"
  exit 0
fi

# ---------------------------
#   REQUIRED DEPENDENCIES
# ---------------------------

# 1) xmlstarlet required
if ! command -v xmlstarlet >/dev/null 2>&1; then
  echo "[http-detect] ERROR: xmlstarlet is not installed. Install it with: sudo apt install xmlstarlet" >&2
  printf "HTTP_CAND=''\nHTTP_VERIFIED=''\n"
  exit 0
fi

# 2) XML must exist
if [ ! -s "$xml_file" ]; then
  echo "[http-detect] ERROR: XML file missing or empty: $xml_file" >&2
  printf "HTTP_CAND=''\nHTTP_VERIFIED=''\n"
  exit 0
fi

# ---------------------------
#     XML-ONLY PROCESSING
# ---------------------------

HTTP_CAND=$(
  xmlstarlet sel -t -m "//port[state/@state='open' and service]" \
    -v "concat(@portid,':',service/@name)" -n "$xml_file" 2>/dev/null \
  | tr '[:upper:]' '[:lower:]' \
  | egrep -i 'http|ssl/http|https' 2>/dev/null \
  | cut -d: -f1 \
  | paste -s -d, - 2>/dev/null || true
)

if [ $VERBOSE -eq 1 ] && [ -n "$HTTP_CAND" ]; then
  echo "[*] detect-http candidates: $HTTP_CAND" >&2
fi

HTTP_VERIFIED="$(probe_ports "$IP" "$HTTP_CAND")"

if [ $VERBOSE -eq 1 ]; then
  echo "[*] detect-http verified: ${HTTP_VERIFIED:-<none>}" >&2
fi

# stdout: ONLY assignments (safe for eval)
printf "HTTP_CAND='%s'\nHTTP_VERIFIED='%s'\n" \
  "${HTTP_CAND//\'/\'\"\'\"\'}" "${HTTP_VERIFIED//\'/\'\"\'\"\'}"
